name: Auto Spider and Hexo Deploy

on:
  push:
    branches:
      - main
  schedule:
    # 每天北京时间上午 8:00 运行 (UTC 0:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许在 GitHub 页面手动点击运行

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # 必须添加以下权限声明，才能让 actions/deploy-pages 有权发布
    permissions:
      contents: write   # 允许提交爬虫数据回仓库
      pages: write      # 允许部署到 GitHub Pages
      id-token: write   # 允许 OIDC 身份验证

    steps:
      # 1. 检出源代码
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }} # 使用自定义 Token 以允许 Action 触发后续流程

      # 2. 安装 Python 环境并运行爬虫
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests jieba

      - name: Run Job Spider
        # 根据你截图中的目录结构运行脚本
        run: python py_scripts/crawler.py

      # 3. 将生成的 JSON 数据提交回仓库 (保证源码分支也有数据)
      - name: Commit Updated Data
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add source/api/jobs_data.json
          # 只有文件变化时才 commit，防止流程报错
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update jobs_data.json [skip ci]" && git push)

      # 4. 安装 Node.js 并生成/部署 Hexo
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm' # 开启缓存加快速度

      - name: Install Hexo Dependencies
        run: |
          npm install

      - name: Build Hexo
        run: |
          npx hexo clean
          npx hexo generate

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # 告诉 GitHub 把 Hexo 生成的 public 文件夹打包上传
          path: 'public/'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4